{"ast":null,"code":"'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar _isEmpty2 = require('lodash/isEmpty');\n\nvar _isEmpty3 = _interopRequireDefault(_isEmpty2);\n\nvar _omit2 = require('lodash/omit');\n\nvar _omit3 = _interopRequireDefault(_omit2);\n\nvar _extends = Object.assign || function (target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i];\n\n    for (var key in source) {\n      if (Object.prototype.hasOwnProperty.call(source, key)) {\n        target[key] = source[key];\n      }\n    }\n  }\n\n  return target;\n};\n\nexports.default = createInstantSearchManager;\n\nvar _algoliasearchHelper = require('algoliasearch-helper');\n\nvar _algoliasearchHelper2 = _interopRequireDefault(_algoliasearchHelper);\n\nvar _createWidgetsManager = require('./createWidgetsManager');\n\nvar _createWidgetsManager2 = _interopRequireDefault(_createWidgetsManager);\n\nvar _createStore = require('./createStore');\n\nvar _createStore2 = _interopRequireDefault(_createStore);\n\nvar _highlightTags = require('./highlightTags.js');\n\nvar _highlightTags2 = _interopRequireDefault(_highlightTags);\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nfunction _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n\n  return obj;\n}\n/**\n * Creates a new instance of the InstantSearchManager which controls the widgets and\n * trigger the search when the widgets are updated.\n * @param {string} indexName - the main index name\n * @param {object} initialState - initial widget state\n * @param {object} SearchParameters - optional additional parameters to send to the algolia API\n * @param {number} stalledSearchDelay - time (in ms) after the search is stalled\n * @return {InstantSearchManager} a new instance of InstantSearchManager\n */\n\n\nfunction createInstantSearchManager(_ref) {\n  var indexName = _ref.indexName,\n      _ref$initialState = _ref.initialState,\n      initialState = _ref$initialState === undefined ? {} : _ref$initialState,\n      algoliaClient = _ref.algoliaClient,\n      _ref$searchParameters = _ref.searchParameters,\n      searchParameters = _ref$searchParameters === undefined ? {} : _ref$searchParameters,\n      resultsState = _ref.resultsState,\n      stalledSearchDelay = _ref.stalledSearchDelay;\n  var baseSP = new _algoliasearchHelper.SearchParameters(_extends({}, searchParameters, {\n    index: indexName\n  }, _highlightTags2.default));\n  var stalledSearchTimer = null;\n  var helper = (0, _algoliasearchHelper2.default)(algoliaClient, indexName, baseSP);\n  helper.on('result', handleSearchSuccess);\n  helper.on('error', handleSearchError);\n  helper.on('search', handleNewSearch);\n  var derivedHelpers = {};\n  var indexMapping = {}; // keep track of the original index where the parameters applied when sortBy is used.\n\n  var initialSearchParameters = helper.state;\n  var widgetsManager = (0, _createWidgetsManager2.default)(onWidgetsUpdate);\n  var store = (0, _createStore2.default)({\n    widgets: initialState,\n    metadata: [],\n    results: resultsState || null,\n    error: null,\n    searching: false,\n    isSearchStalled: true,\n    searchingForFacetValues: false\n  });\n  var skip = false;\n\n  function skipSearch() {\n    skip = true;\n  }\n\n  function updateClient(client) {\n    helper.setClient(client);\n    search();\n  }\n\n  function clearCache() {\n    helper.clearCache();\n    search();\n  }\n\n  function getMetadata(state) {\n    return widgetsManager.getWidgets().filter(function (widget) {\n      return Boolean(widget.getMetadata);\n    }).map(function (widget) {\n      return widget.getMetadata(state);\n    });\n  }\n\n  function getSearchParameters() {\n    indexMapping = {};\n    var sharedParameters = widgetsManager.getWidgets().filter(function (widget) {\n      return Boolean(widget.getSearchParameters);\n    }).filter(function (widget) {\n      return !widget.context.multiIndexContext && (widget.props.indexName === indexName || !widget.props.indexName);\n    }).reduce(function (res, widget) {\n      return widget.getSearchParameters(res);\n    }, initialSearchParameters);\n    indexMapping[sharedParameters.index] = indexName;\n    var derivatedWidgets = widgetsManager.getWidgets().filter(function (widget) {\n      return Boolean(widget.getSearchParameters);\n    }).filter(function (widget) {\n      return widget.context.multiIndexContext && widget.context.multiIndexContext.targetedIndex !== indexName || widget.props.indexName && widget.props.indexName !== indexName;\n    }).reduce(function (indices, widget) {\n      var targetedIndex = widget.context.multiIndexContext ? widget.context.multiIndexContext.targetedIndex : widget.props.indexName;\n      var index = indices.find(function (i) {\n        return i.targetedIndex === targetedIndex;\n      });\n\n      if (index) {\n        index.widgets.push(widget);\n      } else {\n        indices.push({\n          targetedIndex: targetedIndex,\n          widgets: [widget]\n        });\n      }\n\n      return indices;\n    }, []);\n    var mainIndexParameters = widgetsManager.getWidgets().filter(function (widget) {\n      return Boolean(widget.getSearchParameters);\n    }).filter(function (widget) {\n      return widget.context.multiIndexContext && widget.context.multiIndexContext.targetedIndex === indexName || widget.props.indexName && widget.props.indexName === indexName;\n    }).reduce(function (res, widget) {\n      return widget.getSearchParameters(res);\n    }, sharedParameters);\n    indexMapping[mainIndexParameters.index] = indexName;\n    return {\n      sharedParameters: sharedParameters,\n      mainIndexParameters: mainIndexParameters,\n      derivatedWidgets: derivatedWidgets\n    };\n  }\n\n  function search() {\n    if (!skip) {\n      var _getSearchParameters = getSearchParameters(helper.state),\n          sharedParameters = _getSearchParameters.sharedParameters,\n          mainIndexParameters = _getSearchParameters.mainIndexParameters,\n          derivatedWidgets = _getSearchParameters.derivatedWidgets;\n\n      Object.keys(derivedHelpers).forEach(function (key) {\n        return derivedHelpers[key].detach();\n      });\n      derivedHelpers = {};\n      helper.setState(sharedParameters);\n      derivatedWidgets.forEach(function (derivatedSearchParameters) {\n        var index = derivatedSearchParameters.targetedIndex;\n        var derivedHelper = helper.derive(function () {\n          var parameters = derivatedSearchParameters.widgets.reduce(function (res, widget) {\n            return widget.getSearchParameters(res);\n          }, sharedParameters);\n          indexMapping[parameters.index] = index;\n          return parameters;\n        });\n        derivedHelper.on('result', handleSearchSuccess);\n        derivedHelper.on('error', handleSearchError);\n        derivedHelpers[index] = derivedHelper;\n      });\n      helper.setState(mainIndexParameters);\n      helper.search();\n    }\n  }\n\n  function handleSearchSuccess(content) {\n    var state = store.getState();\n    var results = state.results ? state.results : {};\n    /* if switching from mono index to multi index and vice versa,\n    results needs to reset to {}*/\n\n    results = !(0, _isEmpty3.default)(derivedHelpers) && results.getFacetByName ? {} : results;\n\n    if (!(0, _isEmpty3.default)(derivedHelpers)) {\n      results[indexMapping[content.index]] = content;\n    } else {\n      results = content;\n    }\n\n    var currentState = store.getState();\n    var nextIsSearchStalled = currentState.isSearchStalled;\n\n    if (!helper.hasPendingRequests()) {\n      clearTimeout(stalledSearchTimer);\n      stalledSearchTimer = null;\n      nextIsSearchStalled = false;\n    }\n\n    var nextState = (0, _omit3.default)(_extends({}, currentState, {\n      results: results,\n      isSearchStalled: nextIsSearchStalled,\n      searching: false,\n      error: null\n    }), 'resultsFacetValues');\n    store.setState(nextState);\n  }\n\n  function handleSearchError(error) {\n    var currentState = store.getState();\n    var nextIsSearchStalled = currentState.isSearchStalled;\n\n    if (!helper.hasPendingRequests()) {\n      clearTimeout(stalledSearchTimer);\n      nextIsSearchStalled = false;\n    }\n\n    var nextState = (0, _omit3.default)(_extends({}, currentState, {\n      isSearchStalled: nextIsSearchStalled,\n      error: error,\n      searching: false\n    }), 'resultsFacetValues');\n    store.setState(nextState);\n  }\n\n  function handleNewSearch() {\n    if (!stalledSearchTimer) {\n      stalledSearchTimer = setTimeout(function () {\n        var nextState = (0, _omit3.default)(_extends({}, store.getState(), {\n          isSearchStalled: true\n        }), 'resultsFacetValues');\n        store.setState(nextState);\n      }, stalledSearchDelay);\n    }\n  } // Called whenever a widget has been rendered with new props.\n\n\n  function onWidgetsUpdate() {\n    var metadata = getMetadata(store.getState().widgets);\n    store.setState(_extends({}, store.getState(), {\n      metadata: metadata,\n      searching: true\n    })); // Since the `getSearchParameters` method of widgets also depends on props,\n    // the result search parameters might have changed.\n\n    search();\n  }\n\n  function transitionState(nextSearchState) {\n    var searchState = store.getState().widgets;\n    return widgetsManager.getWidgets().filter(function (widget) {\n      return Boolean(widget.transitionState);\n    }).reduce(function (res, widget) {\n      return widget.transitionState(searchState, res);\n    }, nextSearchState);\n  }\n\n  function onExternalStateUpdate(nextSearchState) {\n    var metadata = getMetadata(nextSearchState);\n    store.setState(_extends({}, store.getState(), {\n      widgets: nextSearchState,\n      metadata: metadata,\n      searching: true\n    }));\n    search();\n  }\n\n  function onSearchForFacetValues(_ref2) {\n    var facetName = _ref2.facetName,\n        query = _ref2.query,\n        maxFacetHits = _ref2.maxFacetHits;\n    store.setState(_extends({}, store.getState(), {\n      searchingForFacetValues: true\n    }));\n    helper.searchForFacetValues(facetName, query, maxFacetHits).then(function (content) {\n      var _extends2;\n\n      store.setState(_extends({}, store.getState(), {\n        resultsFacetValues: _extends({}, store.getState().resultsFacetValues, (_extends2 = {}, _defineProperty(_extends2, facetName, content.facetHits), _defineProperty(_extends2, 'query', query), _extends2)),\n        searchingForFacetValues: false\n      }));\n    }, function (error) {\n      store.setState(_extends({}, store.getState(), {\n        error: error,\n        searchingForFacetValues: false\n      }));\n    }).catch(function (error) {\n      // Since setState is synchronous, any error that occurs in the render of a\n      // component will be swallowed by this promise.\n      // This is a trick to make the error show up correctly in the console.\n      // See http://stackoverflow.com/a/30741722/969302\n      setTimeout(function () {\n        throw error;\n      });\n    });\n  }\n\n  function updateIndex(newIndex) {\n    initialSearchParameters = initialSearchParameters.setIndex(newIndex);\n    search();\n  }\n\n  function getWidgetsIds() {\n    return store.getState().metadata.reduce(function (res, meta) {\n      return typeof meta.id !== 'undefined' ? res.concat(meta.id) : res;\n    }, []);\n  }\n\n  return {\n    store: store,\n    widgetsManager: widgetsManager,\n    getWidgetsIds: getWidgetsIds,\n    onExternalStateUpdate: onExternalStateUpdate,\n    transitionState: transitionState,\n    onSearchForFacetValues: onSearchForFacetValues,\n    updateClient: updateClient,\n    updateIndex: updateIndex,\n    clearCache: clearCache,\n    skipSearch: skipSearch\n  };\n}","map":{"version":3,"sources":["D:/Team6-FE/isomorphic/node_modules/react-instantsearch/src/core/createInstantSearchManager.js"],"names":["Object","defineProperty","exports","value","_isEmpty2","require","_isEmpty3","_interopRequireDefault","_omit2","_omit3","_extends","assign","target","i","arguments","length","source","key","prototype","hasOwnProperty","call","default","createInstantSearchManager","_algoliasearchHelper","_algoliasearchHelper2","_createWidgetsManager","_createWidgetsManager2","_createStore","_createStore2","_highlightTags","_highlightTags2","obj","__esModule","_defineProperty","enumerable","configurable","writable","_ref","indexName","_ref$initialState","initialState","undefined","algoliaClient","_ref$searchParameters","searchParameters","resultsState","stalledSearchDelay","baseSP","SearchParameters","index","stalledSearchTimer","helper","on","handleSearchSuccess","handleSearchError","handleNewSearch","derivedHelpers","indexMapping","initialSearchParameters","state","widgetsManager","onWidgetsUpdate","store","widgets","metadata","results","error","searching","isSearchStalled","searchingForFacetValues","skip","skipSearch","updateClient","client","setClient","search","clearCache","getMetadata","getWidgets","filter","widget","Boolean","map","getSearchParameters","sharedParameters","context","multiIndexContext","props","reduce","res","derivatedWidgets","targetedIndex","indices","find","push","mainIndexParameters","_getSearchParameters","keys","forEach","detach","setState","derivatedSearchParameters","derivedHelper","derive","parameters","content","getState","getFacetByName","currentState","nextIsSearchStalled","hasPendingRequests","clearTimeout","nextState","setTimeout","transitionState","nextSearchState","searchState","onExternalStateUpdate","onSearchForFacetValues","_ref2","facetName","query","maxFacetHits","searchForFacetValues","then","_extends2","resultsFacetValues","facetHits","catch","updateIndex","newIndex","setIndex","getWidgetsIds","meta","id","concat"],"mappings":"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","sourcesContent":["'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar _isEmpty2 = require('lodash/isEmpty');\n\nvar _isEmpty3 = _interopRequireDefault(_isEmpty2);\n\nvar _omit2 = require('lodash/omit');\n\nvar _omit3 = _interopRequireDefault(_omit2);\n\nvar _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };\n\nexports.default = createInstantSearchManager;\n\nvar _algoliasearchHelper = require('algoliasearch-helper');\n\nvar _algoliasearchHelper2 = _interopRequireDefault(_algoliasearchHelper);\n\nvar _createWidgetsManager = require('./createWidgetsManager');\n\nvar _createWidgetsManager2 = _interopRequireDefault(_createWidgetsManager);\n\nvar _createStore = require('./createStore');\n\nvar _createStore2 = _interopRequireDefault(_createStore);\n\nvar _highlightTags = require('./highlightTags.js');\n\nvar _highlightTags2 = _interopRequireDefault(_highlightTags);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\n/**\n * Creates a new instance of the InstantSearchManager which controls the widgets and\n * trigger the search when the widgets are updated.\n * @param {string} indexName - the main index name\n * @param {object} initialState - initial widget state\n * @param {object} SearchParameters - optional additional parameters to send to the algolia API\n * @param {number} stalledSearchDelay - time (in ms) after the search is stalled\n * @return {InstantSearchManager} a new instance of InstantSearchManager\n */\nfunction createInstantSearchManager(_ref) {\n  var indexName = _ref.indexName,\n      _ref$initialState = _ref.initialState,\n      initialState = _ref$initialState === undefined ? {} : _ref$initialState,\n      algoliaClient = _ref.algoliaClient,\n      _ref$searchParameters = _ref.searchParameters,\n      searchParameters = _ref$searchParameters === undefined ? {} : _ref$searchParameters,\n      resultsState = _ref.resultsState,\n      stalledSearchDelay = _ref.stalledSearchDelay;\n\n  var baseSP = new _algoliasearchHelper.SearchParameters(_extends({}, searchParameters, {\n    index: indexName\n  }, _highlightTags2.default));\n\n  var stalledSearchTimer = null;\n\n  var helper = (0, _algoliasearchHelper2.default)(algoliaClient, indexName, baseSP);\n  helper.on('result', handleSearchSuccess);\n  helper.on('error', handleSearchError);\n  helper.on('search', handleNewSearch);\n\n  var derivedHelpers = {};\n  var indexMapping = {}; // keep track of the original index where the parameters applied when sortBy is used.\n\n  var initialSearchParameters = helper.state;\n\n  var widgetsManager = (0, _createWidgetsManager2.default)(onWidgetsUpdate);\n\n  var store = (0, _createStore2.default)({\n    widgets: initialState,\n    metadata: [],\n    results: resultsState || null,\n    error: null,\n    searching: false,\n    isSearchStalled: true,\n    searchingForFacetValues: false\n  });\n\n  var skip = false;\n\n  function skipSearch() {\n    skip = true;\n  }\n\n  function updateClient(client) {\n    helper.setClient(client);\n    search();\n  }\n\n  function clearCache() {\n    helper.clearCache();\n    search();\n  }\n\n  function getMetadata(state) {\n    return widgetsManager.getWidgets().filter(function (widget) {\n      return Boolean(widget.getMetadata);\n    }).map(function (widget) {\n      return widget.getMetadata(state);\n    });\n  }\n\n  function getSearchParameters() {\n    indexMapping = {};\n    var sharedParameters = widgetsManager.getWidgets().filter(function (widget) {\n      return Boolean(widget.getSearchParameters);\n    }).filter(function (widget) {\n      return !widget.context.multiIndexContext && (widget.props.indexName === indexName || !widget.props.indexName);\n    }).reduce(function (res, widget) {\n      return widget.getSearchParameters(res);\n    }, initialSearchParameters);\n    indexMapping[sharedParameters.index] = indexName;\n\n    var derivatedWidgets = widgetsManager.getWidgets().filter(function (widget) {\n      return Boolean(widget.getSearchParameters);\n    }).filter(function (widget) {\n      return widget.context.multiIndexContext && widget.context.multiIndexContext.targetedIndex !== indexName || widget.props.indexName && widget.props.indexName !== indexName;\n    }).reduce(function (indices, widget) {\n      var targetedIndex = widget.context.multiIndexContext ? widget.context.multiIndexContext.targetedIndex : widget.props.indexName;\n      var index = indices.find(function (i) {\n        return i.targetedIndex === targetedIndex;\n      });\n      if (index) {\n        index.widgets.push(widget);\n      } else {\n        indices.push({ targetedIndex: targetedIndex, widgets: [widget] });\n      }\n      return indices;\n    }, []);\n\n    var mainIndexParameters = widgetsManager.getWidgets().filter(function (widget) {\n      return Boolean(widget.getSearchParameters);\n    }).filter(function (widget) {\n      return widget.context.multiIndexContext && widget.context.multiIndexContext.targetedIndex === indexName || widget.props.indexName && widget.props.indexName === indexName;\n    }).reduce(function (res, widget) {\n      return widget.getSearchParameters(res);\n    }, sharedParameters);\n\n    indexMapping[mainIndexParameters.index] = indexName;\n\n    return { sharedParameters: sharedParameters, mainIndexParameters: mainIndexParameters, derivatedWidgets: derivatedWidgets };\n  }\n\n  function search() {\n    if (!skip) {\n      var _getSearchParameters = getSearchParameters(helper.state),\n          sharedParameters = _getSearchParameters.sharedParameters,\n          mainIndexParameters = _getSearchParameters.mainIndexParameters,\n          derivatedWidgets = _getSearchParameters.derivatedWidgets;\n\n      Object.keys(derivedHelpers).forEach(function (key) {\n        return derivedHelpers[key].detach();\n      });\n      derivedHelpers = {};\n\n      helper.setState(sharedParameters);\n\n      derivatedWidgets.forEach(function (derivatedSearchParameters) {\n        var index = derivatedSearchParameters.targetedIndex;\n        var derivedHelper = helper.derive(function () {\n          var parameters = derivatedSearchParameters.widgets.reduce(function (res, widget) {\n            return widget.getSearchParameters(res);\n          }, sharedParameters);\n          indexMapping[parameters.index] = index;\n          return parameters;\n        });\n        derivedHelper.on('result', handleSearchSuccess);\n        derivedHelper.on('error', handleSearchError);\n        derivedHelpers[index] = derivedHelper;\n      });\n\n      helper.setState(mainIndexParameters);\n\n      helper.search();\n    }\n  }\n\n  function handleSearchSuccess(content) {\n    var state = store.getState();\n    var results = state.results ? state.results : {};\n\n    /* if switching from mono index to multi index and vice versa,\n    results needs to reset to {}*/\n    results = !(0, _isEmpty3.default)(derivedHelpers) && results.getFacetByName ? {} : results;\n\n    if (!(0, _isEmpty3.default)(derivedHelpers)) {\n      results[indexMapping[content.index]] = content;\n    } else {\n      results = content;\n    }\n\n    var currentState = store.getState();\n    var nextIsSearchStalled = currentState.isSearchStalled;\n    if (!helper.hasPendingRequests()) {\n      clearTimeout(stalledSearchTimer);\n      stalledSearchTimer = null;\n      nextIsSearchStalled = false;\n    }\n\n    var nextState = (0, _omit3.default)(_extends({}, currentState, {\n      results: results,\n      isSearchStalled: nextIsSearchStalled,\n      searching: false,\n      error: null\n    }), 'resultsFacetValues');\n    store.setState(nextState);\n  }\n\n  function handleSearchError(error) {\n    var currentState = store.getState();\n    var nextIsSearchStalled = currentState.isSearchStalled;\n    if (!helper.hasPendingRequests()) {\n      clearTimeout(stalledSearchTimer);\n      nextIsSearchStalled = false;\n    }\n\n    var nextState = (0, _omit3.default)(_extends({}, currentState, {\n      isSearchStalled: nextIsSearchStalled,\n      error: error,\n      searching: false\n    }), 'resultsFacetValues');\n    store.setState(nextState);\n  }\n\n  function handleNewSearch() {\n    if (!stalledSearchTimer) {\n      stalledSearchTimer = setTimeout(function () {\n        var nextState = (0, _omit3.default)(_extends({}, store.getState(), {\n          isSearchStalled: true\n        }), 'resultsFacetValues');\n        store.setState(nextState);\n      }, stalledSearchDelay);\n    }\n  }\n\n  // Called whenever a widget has been rendered with new props.\n  function onWidgetsUpdate() {\n    var metadata = getMetadata(store.getState().widgets);\n\n    store.setState(_extends({}, store.getState(), {\n      metadata: metadata,\n      searching: true\n    }));\n\n    // Since the `getSearchParameters` method of widgets also depends on props,\n    // the result search parameters might have changed.\n    search();\n  }\n\n  function transitionState(nextSearchState) {\n    var searchState = store.getState().widgets;\n    return widgetsManager.getWidgets().filter(function (widget) {\n      return Boolean(widget.transitionState);\n    }).reduce(function (res, widget) {\n      return widget.transitionState(searchState, res);\n    }, nextSearchState);\n  }\n\n  function onExternalStateUpdate(nextSearchState) {\n    var metadata = getMetadata(nextSearchState);\n\n    store.setState(_extends({}, store.getState(), {\n      widgets: nextSearchState,\n      metadata: metadata,\n      searching: true\n    }));\n\n    search();\n  }\n\n  function onSearchForFacetValues(_ref2) {\n    var facetName = _ref2.facetName,\n        query = _ref2.query,\n        maxFacetHits = _ref2.maxFacetHits;\n\n    store.setState(_extends({}, store.getState(), {\n      searchingForFacetValues: true\n    }));\n\n    helper.searchForFacetValues(facetName, query, maxFacetHits).then(function (content) {\n      var _extends2;\n\n      store.setState(_extends({}, store.getState(), {\n        resultsFacetValues: _extends({}, store.getState().resultsFacetValues, (_extends2 = {}, _defineProperty(_extends2, facetName, content.facetHits), _defineProperty(_extends2, 'query', query), _extends2)),\n        searchingForFacetValues: false\n      }));\n    }, function (error) {\n      store.setState(_extends({}, store.getState(), {\n        error: error,\n        searchingForFacetValues: false\n      }));\n    }).catch(function (error) {\n      // Since setState is synchronous, any error that occurs in the render of a\n      // component will be swallowed by this promise.\n      // This is a trick to make the error show up correctly in the console.\n      // See http://stackoverflow.com/a/30741722/969302\n      setTimeout(function () {\n        throw error;\n      });\n    });\n  }\n\n  function updateIndex(newIndex) {\n    initialSearchParameters = initialSearchParameters.setIndex(newIndex);\n    search();\n  }\n\n  function getWidgetsIds() {\n    return store.getState().metadata.reduce(function (res, meta) {\n      return typeof meta.id !== 'undefined' ? res.concat(meta.id) : res;\n    }, []);\n  }\n\n  return {\n    store: store,\n    widgetsManager: widgetsManager,\n    getWidgetsIds: getWidgetsIds,\n    onExternalStateUpdate: onExternalStateUpdate,\n    transitionState: transitionState,\n    onSearchForFacetValues: onSearchForFacetValues,\n    updateClient: updateClient,\n    updateIndex: updateIndex,\n    clearCache: clearCache,\n    skipSearch: skipSearch\n  };\n}"]},"metadata":{},"sourceType":"script"}